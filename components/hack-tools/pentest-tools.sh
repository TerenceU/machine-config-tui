#!/bin/bash
# pentest-tools.sh - Pentest tools submenu

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
source "${SCRIPT_DIR}/lib/utils.sh"

# Get available pentest tools
get_pentest_tools() {
    local tools=()
    for script in "${SCRIPT_DIR}/components/hack-tools/pentest-tools"/*.sh; do
        if [[ -f "$script" ]]; then
            tools+=("$(basename "$script" .sh)")
        fi
    done
    echo "${tools[@]}"
}

# Execute pentest tool installation
execute_pentest_tool() {
    local tool="$1"
    local script="${SCRIPT_DIR}/components/hack-tools/pentest-tools/${tool}.sh"
    
    if [[ ! -f "$script" ]]; then
        log_error "Tool script not found: $script"
        return 1
    fi
    
    log_header "Installing: $tool"
    chmod +x "$script"
    bash "$script" || {
        log_error "Failed to install $tool"
        return 1
    }
    
    return 0
}

main() {
    log_header "Pentest Tools"
    
    local available_tools=($(get_pentest_tools))
    
    if [[ ${#available_tools[@]} -eq 0 ]]; then
        log_error "No pentest tools found"
        return 1
    fi
    
    if ! command_exists gum; then
        log_error "gum is required for submenu"
        return 1
    fi
    
    log_info "Select pentest tools to install (Space to select, Enter to confirm):"
    echo ""
    
    local selected=$(gum choose --no-limit --height 15 "${available_tools[@]}")
    
    if [[ -z "$selected" ]]; then
        log_info "No tools selected"
        return 0
    fi
    
    # Convert to array
    local selected_array=()
    while IFS= read -r line; do
        selected_array+=("$line")
    done <<< "$selected"
    
    echo ""
    gum confirm "Install ${#selected_array[@]} pentest tool(s)?" || {
        log_info "Installation cancelled"
        return 0
    }
    
    # Install selected tools
    local failed=()
    for tool in "${selected_array[@]}"; do
        if execute_pentest_tool "$tool"; then
            log_success "âœ“ $tool installed"
        else
            failed+=("$tool")
        fi
        echo ""
    done
    
    if [[ ${#failed[@]} -gt 0 ]]; then
        log_error "Failed tools: ${failed[*]}"
        return 1
    fi
    
    log_success "All pentest tools installed!"
    return 0
}

main "$@"
